<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服务器管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <style>
        body {
            background-color: #f5f6fa;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .container {
            max-width: 1200px;
            padding: 15px;
        }
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }
        .card-header {
            background-color: #007bff;
            color: white;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            padding: 10px 15px;
        }
        .card-body {
            padding: 15px;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #c82333;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #218838;
        }
        .form-control-sm {
            border-radius: 4px;
            border: 1px solid #ced4da;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .form-control-sm:focus {
            border-color: #007bff;
            box-shadow: 0 0 4px rgba(0, 123, 255, 0.3);
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .table {
            background-color: white;
            border-radius: 6px;
            overflow: hidden;
        }
        .table th {
            background-color: #f8f9fa;
            font-weight: 500;
            padding: 8px;
        }
        .table td {
            vertical-align: middle;
            padding: 8px;
        }
        .table-hover tbody tr:hover {
            background-color: #e9ecef;
        }
        .modal-content {
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }
        .modal-header {
            background-color: #007bff;
            color: white;
            border-radius: 8px 8px 0 0;
            padding: 10px 15px;
        }
        .modal-title {
            font-weight: 500;
        }
        .modal-body {
            padding: 15px;
        }
        .badge-in-use {
            background-color: #28a745;
        }
        .badge-not-in-use {
            background-color: #6c757d;
        }
    </style>
</head>
<body>
<div class="container">
    <h2 class="mt-3 mb-4 text-center">服务器管理</h2>
    <div class="text-end mb-3">
        <a href="/logout" class="btn btn-secondary btn-sm">登出</a>
    </div>

    <!-- 设置表单（合并一行） -->
    <div class="card">
        <div class="card-header">服务器设置</div>
        <div class="card-body">
            <form id="settings-form" class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label for="interval" class="form-label small">更新间隔（小时）</label>
                    <input type="number" name="interval" id="interval" class="form-control form-control-sm" value="{{.Interval}}" required>
                </div>
                <div class="col-md-3">
                    <label for="min_port" class="form-label small">最小端口</label>
                    <input type="number" name="min_port" id="min_port" class="form-control form-control-sm" value="{{.MinPort}}" required>
                </div>
                <div class="col-md-3">
                    <label for="max_port" class="form-label small">最大端口</label>
                    <input type="number" name="max_port" id="max_port" class="form-control form-control-sm" value="{{.MaxPort}}" required>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-success btn-sm w-100">应用设置</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 服务器列表 -->
    <div class="card">
        <div class="card-header">服务器列表</div>
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>名称</th>
                    <th>端口</th>
                    <th>主机</th>
                    <th>域名数（总计/可用）</th>
                    <th>下次更新时间</th>
                    <th>最后更新状态</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                {{range .Servers}}
                <tr data-table="{{.TableName}}" data-id="{{.ID}}">
                    <td class="name">{{.Name}}</td>
                    <td class="port">{{.Port}}</td>
                    <td class="host">{{.Host}}</td>
                    <td class="domain-count">{{formatDomainCount .DomainTotal .DomainAvailable}}</td>
                    <td class="next-update-time">{{formatUnixTime .NextUpdateTime}}</td>
                    <td class="last-update-status">{{.LastUpdateStatus}}</td>
                    <td>
                        <button class="btn btn-primary btn-sm update-btn" data-table="{{.TableName}}" data-id="{{.ID}}">立即更新</button>
                        <button class="btn btn-info btn-sm show-domains-btn" data-table="{{.TableName}}" data-id="{{.ID}}">显示域名</button>
                    </td>
                </tr>
                {{end}}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 域名列表模态框 -->
    <div class="modal fade" id="domainModal" tabindex="-1" aria-labelledby="domainModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="domainModalLabel">域名列表</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 添加新域名表单 -->
                    <form id="add-domain-form" class="mb-3">
                        <div class="row g-2">
                            <div class="col-md-8">
                                <input type="hidden" name="table" id="add-domain-table">
                                <input type="hidden" name="id" id="add-domain-id">
                                <input type="text" name="domain" class="form-control form-control-sm" placeholder="输入新域名（如 example.com）" required>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-success btn-sm w-100">添加域名</button>
                            </div>
                        </div>
                    </form>
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>域名</th>
                            <th>状态</th>
                            <th>上次使用时间</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody id="domain-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 格式化时间戳
    function formatUnixTime(timestamp) {
        if (!timestamp || timestamp === 0) {
            return "从未使用";
        }
        return new Date(timestamp * 1000).toLocaleString("zh-CN", {
            timeZone: "Asia/Shanghai",
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
        });
    }

    // 格式化域名计数
    function formatDomainCount(total, available) {
        return total + "/" + available;
    }

    $(document).ready(function() {
        // 显示域名列表
        $(".show-domains-btn").click(function() {
            var button = $(this);
            var table = button.data("table");
            var id = button.data("id");
            console.log("Fetching domains for table:", table, "id:", id);
            $("#add-domain-table").val(table);
            $("#add-domain-id").val(id);
            $.ajax({
                url: "/available-domains",
                method: "GET",
                data: { table: table, id: id },
                success: function(response) {
                    console.log("Domains response:", response);
                    var tbody = $("#domain-list");
                    tbody.empty();
                    response.domains.forEach(function(domain) {
                        var status = domain.in_use ?
                            '<span class="badge badge-in-use">正在使用</span>' :
                            '<span class="badge badge-not-in-use">未使用</span>';
                        var row = `<tr>
                                <td>${domain.domain}</td>
                                <td>${status}</td>
                                <td>${formatUnixTime(domain.last_used_time)}</td>
                                <td><button class="btn btn-danger btn-sm delete-domain-btn" data-table="${table}" data-id="${id}" data-domain-id="${domain.id}">删除</button></td>
                            </tr>`;
                        tbody.append(row);
                    });
                    $("#domainModal").modal("show");
                },
                error: function(xhr) {
                    console.error("Fetch domains failed:", xhr.responseJSON);
                    alert("获取域名列表失败：" + (xhr.responseJSON ? xhr.responseJSON.error : "未知错误"));
                }
            });
        });

        // 立即更新
        $(".update-btn").click(function() {
            var button = $(this);
            var table = button.data("table");
            var id = button.data("id");
            console.log("Updating server for table:", table, "id:", id);
            $.ajax({
                url: "/update-now",
                method: "POST",
                data: { table: table, id: id },
                success: function(response) {
                    console.log("Update response:", response);
                    alert(response.message);
                    var row = $(`tr[data-table="${table}"][data-id="${id}"]`);
                    row.find(".port").text(response.port || "");
                    row.find(".host").text(response.host || "");
                    row.find(".domain-count").text(formatDomainCount(response.domain_total, response.domain_available));
                    row.find(".next-update-time").text(formatUnixTime(response.next_update_time));
                    row.find(".last-update-status").text(response.last_update_status || "");
                    $(`.show-domains-btn[data-table="${table}"][data-id="${id}"]`).click();
                },
                error: function(xhr) {
                    console.error("Update failed:", xhr.responseJSON);
                    alert("更新失败：" + (xhr.responseJSON ? xhr.responseJSON.error : "未知错误"));
                }
            });
        });

        // 添加域名
        $("#add-domain-form").submit(function(e) {
            e.preventDefault();
            var table = $("#add-domain-table").val();
            var id = $("#add-domain-id").val();
            $.ajax({
                url: "/add-domain",
                method: "POST",
                data: $(this).serialize(),
                success: function(response) {
                    alert(response.message);
                    $(`tr[data-table="${table}"][data-id="${id}"]`).find(".domain-count").text(formatDomainCount(response.domain_total, response.domain_available));
                    $(`.show-domains-btn[data-table="${table}"][data-id="${id}"]`).click();
                    $("#add-domain-form")[0].reset();
                },
                error: function(xhr) {
                    alert("添加域名失败：" + (xhr.responseJSON ? xhr.responseJSON.error : "未知错误"));
                }
            });
        });

        // 删除域名
        $(document).on("click", ".delete-domain-btn", function() {
            var button = $(this);
            var table = button.data("table");
            var id = button.data("id");
            var domainId = button.data("domain-id");
            if (confirm("确定要删除此域名吗？")) {
                $.ajax({
                    url: "/delete-domain",
                    method: "POST",
                    data: { table: table, id: id, domain_id: domainId },
                    success: function(response) {
                        alert(response.message);
                        var row = $(`tr[data-table="${table}"][data-id="${id}"]`);
                        row.find(".domain-count").text(formatDomainCount(response.domain_total, response.domain_available));
                        button.closest("tr").remove();
                    },
                    error: function(xhr) {
                        alert("删除域名失败：" + (xhr.responseJSON ? xhr.responseJSON.error : "未知错误"));
                    }
                });
            }
        });

        // 应用设置（合并更新间隔和端口范围）
        $("#settings-form").submit(function(e) {
            e.preventDefault();
            var formData = $(this).serialize();
            // 先提交更新间隔
            $.ajax({
                url: "/set-interval",
                method: "POST",
                data: { interval: $("#interval").val() },
                success: function(response) {
                    console.log("Set interval success:", response);
                    // 再提交端口范围
                    $.ajax({
                        url: "/set-port-range",
                        method: "POST",
                        data: { min_port: $("#min_port").val(), max_port: $("#max_port").val() },
                        success: function(response) {
                            alert("设置已成功应用");
                            location.reload();
                        },
                        error: function(xhr) {
                            alert("设置端口范围失败：" + (xhr.responseJSON ? xhr.responseJSON.error : "未知错误"));
                        }
                    });
                },
                error: function(xhr) {
                    alert("设置间隔失败：" + (xhr.responseJSON ? xhr.responseJSON.error : "未知错误"));
                }
            });
        });
    });
</script>
</body>
</html>